
# Протоколы состояния канала и однозоновый OSPF (часть 1)

### Основы протоколов состояния канала

Вы знакомы с поведением протоколов состояния канала из курса CCNA, но сейчас мы собираемся пересмотреть важные моменты.

_Избегайте соблазна пропустить обзор._

А пока совсем немногое вам будет знакомо — есть множество дополнительных деталей, которыми вы должны овладеть как CCNP. Для тех, кто собирается сдавать CCIE, нужно по-настоящему освоить принцип работы OSPF.

Когда RIP посылает обновления маршрутов, они содержат полную таблицу маршрутизации. Включая отладку командой _debug ip rip_, вы можете увидеть маршруты, содержащиеся в обновлении вместе с метрикой.

Протоколы состояния канала работают по-другому. Маршрутизаторы состояния канала, которые сформировали соседство, обмениваются пакетами LSU, которые содержат анонсы LSA. Эти анонсы LSA несут информацию о масках подсетей и позволяют OSPF поддерживать маски переменной длины (VLSM).

LSA анонсы помещаются в базу данных состояния канала. Алгоритм Дейкстры (также известный как алгоритм поиска первого кратчайшего пути, SPF) работает с содержимым этой базы данных для создания таблицы маршрутизации OSPF.

Маршрутизаторы должны синхронизировать свои базы данных состояния канала.

Для просмотра содержимого базы данных состояния канала введите команду _show ip ospf database_. Эта команда показывает каналы и типы соединений, порядковые номера и как давно был получен определенный анонс LSA. Это значение в секундах можно посмотреть в колонке «age».

Алгоритм Дейкстры работает с содержимым базы данных…

    R1#show ip ospf database
         OSPF router with ID (1.1.1.1) (Process ID 1)
    Link ID     ADV Router     Age     Seq#          Checksum
    1.1.1.1     1.1.1.1        1286    0x80000006    0x0057A7
    8.8.8.8     8.8.8.8        795     0x8000000C    0x00085E
         Net Link States (Area 0)
    Link ID     ADV Router     Age     Seq#          Checksum
    10.1.1.5    8.8.8.8        795     0x80000006    0x001CC3

  
… вычисляет маршруты, и эти маршруты помещаются в таблицу маршрутизации OSPF

    R1#show ip route ospf
    	6.0.0.0/32 is subnetted, 1 subnets
    O       6.6.6.6[110/11] via 10.1.1.5, 02:32:53, Ethernet0
    	7.0.0.0/32 is subnetted, 1 subnets
    O       7.7.7.7[110/11] via 10.1.1.5, 02:32:53, Ethernet0

  
Алгоритм SPF на самом деле вычисляет кратчайший путь вдоль дерева, и это дерево используется для создания таблицы маршрутизации. Больше об этом алгоритме задумываться не следует, так как он делает все замечательно и без нашего вмешательства, но у нас есть куча деталей, на которые стоит обратить внимание!

### Порядковые номера LSA
  
Для того чтобы убедиться, что маршрутизаторы OSPF получают самую последнюю информацию, LSA присваиваются порядковые номера. Когда маршрутизатор с OSPF получает LSA, он проверяет по своей базе данных, есть ли в ней запись для данного канала или нет.

Если записи нет, то маршрутизатор создает ее и рассылает данный анонс LSA по всем OSPF-интерфейсам, кроме того, на котором было получено это сообщение.

Если запись есть, то возможно несколько вариантов. В зависимости от значения порядкового номера LSA — больше, меньше или равен он содержащемуся в базе данных.

\--Если номер совпадает, анонс LSA игнорируется и никаких действий больше не предпринимается.

\--Если номер меньше, маршрутизатор проигнорирует обновление и передаст пакет LSU, содержащий данный анонс LSA, обратно отправителю. В этой ситуации, маршрутизатор с более свежей информацией сообщает отправителю: «Информация, которую вы отправляете, устарела. Вот та, что следует рассылать.»

\--Если порядковый номер больше, маршрутизатор добавит этот анонс LSA в свою базу данных и отправит подтверждение (LSAcknowledgement). Затем маршрутизатор будет рассылать этот анонс LSA и запустит алгоритм SPF для обновления собственной таблицы маршрутизации.

### Когда происходит обмен анонсами LSA?
  
Дистанционно-векторные протоколы отправляют обновления регулярно через определенный интервал времени, безотносительно того, были изменения в топологии сети или нет. Для стабильной сети это напрасная трата ресурсов. После первоначального обмена анонсами LSA между двумя соседями OSPF, другого обмена анонсами не происходит, пока не изменится топология сети.

Маршрутизатор OSPF также рассылает суммарные анонсы LSA каждые 30 минут.

До обмена анонсами LSA, маршрутизаторы должны стать соседями, формируя соседство. Для этого у маршрутизаторов должны совпадать номер зоны, hello- и dead-таймеры и нужно проверить является ли зона «stub»-зоной. Если есть аутентификация, то она должна быть сконфигурирована на обеих сторонах канала.

Номер самого процесса OSPF локально значим и не влияет на процесс установления соседства.

Для проверки соседства, введите команду _show ip ospf neighbor_ или менее употребительную _show ip ospf interface_. Эту последнюю команду часто забывают, но она дает много полезной информации.

Заметьте, что обе команды покажут вам какие отношения соседства существуют, и только _show ip ospf neighbor_ покажет статус загрузки базы данных (FULL, 2WAY, и т.д.)

    R3#show ip ospf neighbor

    Neighbor ID   Pri   State      Dead Time    Address       Interface
    1.1.1.1       1     FULL/DR    00:01:52     172.12.123.1  Serial0
    1.1.1.1       1     FULL/ -    00:00:32     172.12.13.1   Serial1
    4.4.4.4       1     FULL/DR    00:00:32     172.23.23.4   Ethernat0

    R3#show ip ospf interface serial0
    Serial0 is up, line protocol is up
    	Internet address 172.12.123.3/24, Area0
    	Process ID 1, Router ID 3.3.3.3, Network Type NON_BROADCAST, Cost: 64
    	Transmit Delay is 1 sec, State DROTHER, Priority 0
    	Designated Router (ID) 1.1.1.1, Interface Address 172.12.123.1
    	No backup designated router on this network
    	Timer intervals configured, Hello 30, Dead 120, Wait 120, Retransmit 5
    	  Hello due in 00:00:16
    	Index 1/1, flood queue length 0
    	Next 0x0(0)/0x0(0)
    	Last flood scan length is 1, maximum is 3
    	Last flood scan time is 0 msec, maximum is 4 msec
    	Neighbor count is 1, Adjacent neighbor count is 1
    	  Adjacent with Neighbor 1.1.1.1 (Designated Router)
    	  Supress Hello for 0 neighbor(s)

  
_show ip ospf interface_ даст вам локальный идентификатор маршрутизатора OSPF (RID), его роль в данном сегменте (DR, BDR, DROther), идентификатор (RID) DR или BDR для данного сегмента и многое другое. Это замечательный отправной пункт для устранения проблем.

### Роль DR и BDR
  
Главный недостаток дистанционно-векторных протоколов — медленная конвергенция.

_Конвергенция_ означает состояние сети, когда каждый маршрутизатор имеет подобное другим маршрутизаторам и точное представление о сети, особенно после изменения топологии, как, например, при отключенном маршруте. Дистанционно-векторные протоколы не конвергируют достаточно быстро, что может привести к неоптимальной маршрутизации и маршрутным петлям.

Протоколы состояния канала конвергируют почти сразу после изменения топологии. OSPF использует выделенные маршруты и запасные выделенные маршруты для быстрой и правильной конвергенции в сети.

### Как DR рассылают сообщения об изменениях в сети

  
Когда маршрутизатор в OSPF сегменте с DR и BDR замечает изменения в сети, он не уведомляет всех соседей. Вместо этого он отправляет мультикаст на 224.0.0.6, адрес, который слушают оба маршрутизатора — DR и BDR, чтобы знать о таких изменениях.

Затем DR отправляет мультикаст на 224.0.0.5 — уведомить все не-DR и не-BDR маршрутизаторы в сети. (Маршрутизаторы, которые не являются DR или BDR, называются DROthers, как показано в выводе команды _show ip ospf neighbor_). DROther-ы отправляют подтверждение (LSAcknowledgment, LSAck) обратно DR о получении обновления.

Два замечания:

\--Только DR и BDR слушают 224.0.0.6.

\--Только DR отправляет мультикаст на 224.0.0.5 для уведомления DROthers об изменениях в сети. BDR получают их, но не уведомляют другие маршрутизаторы. Прослушивание 224.0.0.6 дает BDR возможность иметь последние изменения в базе данных — и это важно на тот случай, если он станет DR.

### Процесс выбора DR/BDR
  
_Почти_ каждый сегмент сети OSPF содержит DR и BDR. Как всегда имеются исключения, и мы обсудим эти ситуации далее. А сейчас, давайте взглянем поближе на правила выбора DR и BDR.

Согласно следующей диаграмме сети (я мог бы поместить в центр коммутатор вместо обозначения сегмента «Ethernet»; будьте готовы встретить такое в сетевой документации).

![][1]

Интерфейсы четырех маршрутизаторов находятся в сегменте Ethernet. Один станет DR, другой BDR, остальные — DROthers. Перед тем как увидеть, как маршрутизаторы Cisco распределяют эти роли, давайте взглянем на процесс выбора DR/BDR.

1\. Все маршрутизаторы с приоритетом интерфейса 1 или выше могут быть выбранными в качестве DR/BDR. Установка приоритета в 0 лишает маршрутизатор такой возможности.

2\. Маршрутизатор с наибольшим приоритетом становится DR.

3\. Если они совпадают, то сравниваются значения идентификатора RID. Маршрутизатор с наибольшим — выигрывает.

4\. Этот процесс повторяется для выбора нового BDR. Один и тот же маршрутизатор не может быть одновременно DR и BDR.

Позже мы обсудим интересное поведение DROthers в сегменте Ethernet. А сейчас сфокусируемся на процессе выбора DR/BDR с использованием OSPF RID.

### Процесс выбора с OSPF RID

Очевидно, OSPF RID играет большую роль в выборе DR и BDR — но как определяется значение RID? По следующим правилам:

OSPF RID маршрутизатора будет наибольший IP адрес, назначенный loopback-интерфейсу, безотносительно был ли этот интерфейс включен в процесс OSPF. Он не анонсируется автоматически OSPF.

Если нет петлевых (loopback) интерфейсов, OSPF RID маршрутизатора будет наибольшее значение IP адреса, назначенного физическому интерфейсу, безотносительно включен он в OSPF ли нет.

Эти правила могут быть переписаны установкой OSPF RID вручную командой _router-id_, но на маршрутизаторе должен быть перезапущен процесс OSPF (cleared).

Кажется немного странным, что петлевые интерфейсы, не участвующие в OSPF, определяют RID, не так ли?  
Давайте посмотрим на все в действии. R1 и R5 сформировали соседство в подсети 10.1.1.0/24. У R5 есть несколько петлевых интерфейсов, но анонсируются через OSPF только два:

    hostname R5
    !
    interface Loopback6
     ip address 6.6.6.6 255.255.255.255
    !
    interface Loopback7
     ip address 7.7.7.7 255.255.255.255
    !
    interface Loopback8
     ip address 8.8.8.8 255.255.255.255
    !
    interface Ethernet0
     ip address 10.1.1.5 255.255.255.0
    !

    router ospf 1
     network 6.6.6.6 0.0.0.0 area 0
     network 7.7.7.7 0.0.0.0 area 0
     network 10.1.1.0 0.0.0.255 area 0

  
Зная правила определения OSPF RID, какой OSPF RID покажет R1 для R5? Посмотрите на конфигурацию и выясните.

Если вы сказали 8.8.8.8, то вы правы. Чтобы увидеть OSPF RID соседа надо ввести _show ip ospf neighbor_:

    R1#show ip ospf neighbor
    Neighbor ID   Pri   State      Dead Time    Address       Interface
    8.8.8.8       1     FULL/DR    00:00:37     10.1.1.5      Ethernet0
  
Значение, указанное под _Neighbor ID_ это RID соседа.

Для иллюстрации другой важной вещи, касающейся DR и BDR, давайте вернемся к нашему примеру с четырьмя маршрутизаторами. Маршрутизаторы имеют следующие адреса:

    RouterA: Loopback 1.1.1.1, ethernet0 172.1.1.1
    RouterB: Loopback 2.2.2.2, ethernet0 172.1.1.2
    RouterC: No loopback, ethernet0 172.1.1.3
    RouterD: No loopback, ethernet0 172.1.1.4

  
RID будут такими:

    RouterA: 1.1.1.1
    RouterB: 2.2.2.2
    RouterC: 172.1.1.3
    RouterD: 172.1.1.4
  
Процесс выбора RID всегда отдает предпочтение IP адресам петлевых интерфейсов над физическими.

Суммируя сказанное, мы имеем три способа влияния на значение RID:

\--Изменение приоритета OSPF с помощью команды _ip ospf priority_

\--Установка RID вручную при помощи _router-id_

\--Установка RID путем конфигурирования петлевого интерфейса

Ни один из этих способов не является «ошибочным» или «правильным» — так что знайте все три, и знайте, что нужно перезапускать процессы OSPF для применения изменений.

### Что случится, если DR отключится, а затем включится?

Если все четыре маршрутизатора включились одновременно, мы ожидаем, что маршрутизатор D будет DR и маршрутизатор C — BDR. Но что, если маршрутизатор D отключится, а потом включится?

При отсутствии маршрутизатора D, маршрутизатор C становится DR. Маршрутизатор B будет BDR. А затем маршрутизатор D включается, но _маршрутизаторы C и B сохраняют свои роли._

Это не похоже на протокол связующего дерева, где новый коммутатор, с меньшим BID становится корневым. В OSPF выбор DR/BDR не меняется при включении нового маршрутизатора или включении того, который ранее был DR или BDR.

Давайте рассмотрим пример с тремя маршрутизаторами в сегменте Ethernet. Приоритет маршрутизатора A — 100, B — 50, C — 10. Маршрутизатор A выбран DR, B — BDR.

![][2]

Все хорошо, пока не выключается маршрутизатор A. Маршрутизаторы B и C становятся соответственно DR и BDR.

![][3]

Включение маршрутизатора A — не причина перевыбирать DR/BDR, даже если приоритет маршрутизатора A выше, чем у DR и BDR. При включении маршрутизатор A становится DROther.

![][4]

Чтобы маршрутизатор A стал вновь DR, оба текущих DR и BDR должны отключиться! Что произойдет, когда отключится маршрутизатор B?

![][5]

Маршрутизатор C становится DR, маршрутизатор A — BDR. При включении маршрутизатора B он будет DROther.

![][6]

Для окончательной установки в качестве DR маршрутизатора A отключаем маршрутизатор C. Теперь маршрутизатор A из BDR станет DR, а маршрутизатор B — BDR.

![][7]

При включении маршрутизатора C он станет DROther, и мы получим прежнюю схему сети!

![][2]  

### Типы сетей OSPF

### Почему типы сетей OSPF важны
  
По умолчанию тип сети OSPF зависит от типа сегмента сети. Различные типы сетей OSPF имеют различные значения hello- и dead- таймеров, и это одни из значений, которые должны совпадать для установления соседства между двумя маршрутизаторами. Кроме того, некоторые типы сетей OSPF не имеют DR и BDR, а у других есть особые условия, которые необходимо соблюдать.

Кроме того, они все одинаковые, правильно? :)

Не беспокойтесь, мы рассмотрим каждый тип сети OSPF, необходимый для сдачи экзамена CСNP ROUTE!

Если не указано иное, сегмент сети находится в зоне 0 — основной зоне.

Адрес подсети широковещательной сети — 10.1.1.0/24. Последний октет каждого IP адреса будет номером маршрутизатора. Каждый маршрутизатор имеет петлевой интерфейс, с номером маршрутизатора в каждом октете. (Петлевой интерфейс для R1 — 1.1.1.1/32 и т.д.)

### Широковещательная сеть OSPF

  
![][8]  
Конфигурация OSPF в сегменте Ethernet для широковещательной сети будет оставлена по-умолчанию, также будут выбраны DR и BDR, для влияния на выбор DR/BDR можно использовать команду _ip ospf priority_.

Для большого сегмента сети хорошая идея использовать мощные маршрутизаторы для выполнения этих ролей (DR/BDR), так как это влечет за собой нагрузку на CPU. Как всегда, все, что мы делаем на маршрутизаторе имеет свою цену.

Вывод команды _show ip ospf interface ethernet0_ на маршрутизаторе R1 показывает нам тип сети, а также много другой информации. Заметьте, значения по-умолчанию hello- и dead- таймеров широковещательной сети — 10 и 40 секунд соответственно. По-умолчанию dead time равен четырехкратному hello time.

    R1#show ip ospf interface ethernet0
    Ethernet0 is up, line protocol is up
      Internet Address 10.1.1.1/24, Area 0
      Process ID 1, Router ID 1.1.1.1, Network Type BROADCAST, Cost: 10
      Transmit Delay is 1 sec, State BDR, Priority 1
      Designated Router (ID) 8.8.8.8, Interface address 10.1.1.5
      Backup Designated Router (ID) 1.1.1.1, Interface address 10.1.1.1
      Timer Intervals configured, Hello 10, Dead 40, Wait 40, Retransmit 5
         Hello due in 00:00:04
      Index 1/1, flood queue length 0

    Next 0x0(0)/0x0(0)
    Last flood scan length is 1, maximum is 2
    Last flood scan time is 0 msec, maximum is 4 msec
    Neighbor Count is 1, Adjacent neighbor count is 1
      Adjacent  with neighbor 8.8.8.8 (Designated Router)
    Supress hello for 0 neighbor(s)

  
Для широковещательного сегмента _не обязательно_ делать определенный маршрутизатор DR или BDR, но для нашего следующего примера это не так.

### Сеть OSPF NBMA

  
Сейчас мы добавим еще сегмент к существующей сети, на frame relay. Новый сегмент использует адрес 172.12.123.0/24. От R1 идет два канала PVC до R2 и R3; между «спицами»(spoke) PVC нет. Интерфейс Serial0 каждого маршрутизатора находится в зоне 0.   
![][9]  
Последовательные интерфейсы в этом новом сегменте по-умолчанию будут нешироковещательными с множественным доступом (NBMA). Так как узлы сети не образуют полносвязную сеть, хаб-маршрутизатор R1 должен быть DR и здесь может не быть BDR.  
Почему? У DR и любого потенциального BDR должна быть возможность получать мультикаст от всех остальных маршрутизаторов в сети. В топологии «звезда» у spoke-маршрутизатора нет возможности получать широковещательный или мультикаст трафик от другого spoke-маршрутизатора, так как весь трафик проходит через хаб — а маршрутизаторы не перенаправляют широковещательный или мультикаст трафик!  
Перед настройкой любой OSPF конфигурации поверх frame relay, убедитесь, что опция _broadcast_ у вас включена!  
Иначе OSPF пакеты не будут передаваться через frame relay.

    R1(config-if)#frame map ip 172.12.123.2 122 broadcast
    R1(config-if)#frame map ip 172.12.123.3 123 broadcast

    R1#show frame map
    Serial0(up): ip 172.12.123.2 dlci 122(0x7A,0x1CA0),static,
                 broadcast,
                 CISCO, status defined, active
    Serial0(up): ip 172.12.123.3 dlci 123(0x7B,0x1CB0),static,
                 broadcast,
                 CISCO, status defined, active

  
Недостаточно просто убедиться, что R1 стал DR — мы должны предотвратить возможность становления DR/BDR для R2 и R3! Для этого изменим приоритет со значения по-умолчанию (1) на 0.

    R2(config)#int s0
    R2(config-if)#ip ospf priority 0

    R3(config)#int s0
    R3(config-if)#ip ospf priority 0

  
Маршрутизатор с наибольшим значением приоритета интерфейса, на котором включен OSPF, становится DR. Если значения приоритета равны, то сравниваются идентификаторы маршрутизаторов (RID), выигрывает — наибольший.  
Фактически, мы мошенничаем с выбором DR, не оставляя шансов для spoke-маршрутизаторов, даже при исчезновении хаба! Установка приоритета в 0 для spoke-маршрутизаторов не оставляет им возможности стать DR в случае перезагрузки хаб-маршрутизатора.  
«NB» в слове NBMA означает «нешироковещательный», так что при конфигурировании хаб-маршрутизатора нужно вручную указывать соседей, как показано ниже. Для spoke-маршрутизаторов такое не требуется.

    R1#conf t
    Enter configuration commands, one per line. End with CTRL+Z. R1(config)#router ospf 1
    R1(config-router)#network 172.12.123.0 0.0.0.255 area 0
    R1(config-router)#neighbor 172.12.123.2
    R1(config-router)#neighbor 172.12.123.3

    R1#show ip ospf interface serial0
    Serial0 is up, line protocol is up
      Internet Address 172.12.123.1/24, Area 0
      Process ID 1, Router ID 1.1.1.1, Network Type NON_BROADCAST, Cost: 64
      Transmit Delay is 1 sec, State DR, Priority 1
      Designated Router (ID) 1.1.1.1, Interface address 172.12.123.1
    No backup designated router on this network
      Timer intervals configured, Hello 30, Dead 120, Wait 120, Retransmit 5
        Hello due to 00:00:11
      Index 2/2, flood queue length 0
      Next 0x0(0)/0x0(0)
      Last flood scan length is 1, maximum is 2
      Last flood scan time is 4 msec, maximum is 4 msec
      Neighbor Count is 2, Adjacent neighbor count is 2
        Adjacent with neighbor 3.3.3.3
        Adjacent with neighbor 2.2.2.2
      Supress hello for 0 neighbor(s)

  
У вас может быть сеть NBMA c DR и BDR, но они оба должны быть хаб-маршрутизаторами. Сеть с двумя хабами может использовать один как DR, другой как BDR. Каждый DR или BDR должен иметь статически настроенных соседей; такая настройка не нужна на других маршрутизаторах. (Если у вас много хаб-маршрутизаторов, один из них может быть BDR).  
Заметьте, hello- и dead- таймеры равны 30 и 120 соответственно. Dead-таймер снова в четыре раза больше, чем hello.  
Последовательные интерфейсы по-умолчанию NBMA, но вы можете изменить тип сети OSPF интерфейса командой _ip ospf network_.

    R1(config-if)#ip ospf network ?
      broadcast              Specify OSPF broadcast multi-access network
      non-broadcast          Specify OSPF NBMA network
      point-to-multipoint    Specify OSPF point-to-multipoint network
      point-to-point    Specify OSPF point-to-point network

  

### Типы сетей OSPF Point-To-Point и Point-To-Multipoint

  
Сейчас мы добавим прямое соединение между R1 и R3, но расположим его в зоне 13. Номер подсети 172.12.13.0/27. Интерфейсы Serial1 обоих маршрутизаторов находятся в этой зоне 13.  
![][10]  
Все non-backbone зоны должны иметь маршрутизатор с логическим или физическим интерфейсом в основной зоне 0. В зоне 13 два таких маршрутизатора, так что конфигурация правильная.  
_show ip ospf interface serial1_ покажет данный сегмент OSPF по-умолчанию для типа сети OSPF point-to-point. Этот вывод показывает также по-умолчанию hello- и dead- таймеры для данного типа сети — 10 и 40 секунд соответственно.

    R1#show ip ospf interface serial1
    Serial1 is up, line protocol is up
      Internet Address 172.12.13.3/27, Area 13
      Process ID 1, Router ID 3.3.3.3, Network Type POINT_TO_POINT, Cost: 64
      Transmit Delay is 1 sec, State POINT_TO_POINT,
      Timer intervals configured, Hello 10, Dead 40, Wait 40, Retransmit 5
        Hello due to 00:00:08
      Index 1/2, flood queue length 0
      Next 0x0(0)/0x0(0)
      Last flood scan length is 1, maximum is 1
      Last flood scan time is 0 msec, maximum is 0 msec
      Neighbor Count is 1, Adjacent neighbor count is 1
        Adjacent with neighbor 1.1.1.1
      Supress hello for 0 neighbor(s)

  
Заметьте, что в списке нет DR и BDR. В канале «точка-точка» только два маршрутизатора. Следовательно, нет необходимости даже иметь DR или BDR, и ни один маршрутизатор не будет выбран в качестве таковых.  
_show ip ospf neighbor_ показывает прочерки на месте, где обычно указана роль соседа. Процесс выбора DR/BDR опускается в point-to-point и point-to-multipoint сетях. Команда neighbor обычно не нужна в этих сетях. Ниже R3 видит R1 как DR в сети NBMA, тогда как он же без роли видим в сети point-to-point.

    R3#show ip ospf neighbor
    Neighbor ID   Pri State      Dead Time     Address       Interface
    1.1.1.1         1 FULL/DR    00:01:46      172.12.123.1  Serial0
    1.1.1.1         1 FULL/-     00:00:35      172.12.13.1   Serial1

  
Прочерк после FULL/ показывает, что сосед не является ни DR, ни BDR, ни DROther, что означает, что процесса выбора DR/BDR не было. Вы увидите подобную ситуацию в _OSPF сети point-to-multipoint_, что OSPF воспринимает, как набор каналов point-to-point.  
Например, мы можем вернуться и изменить конфигурацию OSPF сети frame relay как сети point-to-multipoint командой _ip ospf network point-to-multipoint_ на последовательном интерфейсе маршрутизатора R1. DR/BDR выбраны не будут и команда neighbor не нужна.  
Теперь сеть OSPF типа point-to-multipoint предлагает два варианта — широковещательная и нет.

### Конфигурация широковещательной OSPF сети Point-To-Multipoint

  
Этот тип сети не требует команды _neighbor_, но вы можете определить стоимость для данного соседа.

    R1#ip ospf network point-to-multipoint ?
       non-broadcast     Specify non-broadcast point-to-multipoint network
       

  
Заметьте, что опция _broadcast_ отсутствует, так как по-умолчанию сети типа point-to-multipoint — широковещательные.

    R1(config-if)#router ospf 1
    R1(config-router)#neighbor 172.12.123.2 ?
               cost            OSPF cost for point-to-multipoint neighbor
               database-       Filter OSPF LSA during synchronization and flooding for point-to-multipoint
               filter          neighbor
               poll-interval   OSPF dead-router polling interval
               priority        OSPF priority of non-broadcast neighbor
               

    R1(config-router)#neighbor 172.12.123.2 cost ?
       <1-65535>   metric
    R1(config-router)#neighbor 172.12.123.2 cost 20

  

### Нешироковещательная OSPF сеть Point-To-Multipoint

  
С другой стороны, в нешироковещательной сети point-to-multipoint команда _neighbor_ требуется. Вы можете добавить стоимость для соседа, но соседи _должны_ быть статически определены для данного типа сети.

    R1(config-if)#ip ospf network point-to-multipoint non-broadcast

    R1(config-router)#neighbor 172.12.123.2 cost 15
    R1(config-router)#neighbor 172.12.123.3 cost 25

  

### Запуск широковещательных OSPF сетей над топологией NBMA

  

### То, что вы можете что-то сделать, не означает, что вы должны это делать!

  
Нам следует использовать команду _ip ospf network broadcast_ на всех маршрутизаторах сети frame relay, и, так как сеть полносвязная, технически все должно работать и маршрутизаторы будут вести себя так, как если бы были в LAN сети.  
В реальной жизни использование широковещательной OSPF сети в сегменте NBMA может привести к непредсказуемым результатам, и лично я не стал бы так делать.  
Зачем тратить время на устранение проблем, когда можно придерживаться настроек по-умолчанию?

### Виртуальный канал (virtual link) OSPF

  
Настройки OSFP сети, запущенной через frame relay, были восстановлены до значений по-умолчанию для сети типа NBMA и останутся таковыми до конца данного раздела.  
Сейчас мы добавим маршрутизатор R4 в нашу сеть. R4 и R3 будут соседями через зону 34, у R4 будет петлевой интерфейс в зоне 4. Адрес подсети для сегмента между R3 и R4 — 172.12.34.0/24, сегмент ethernet.  
![][11]

Результат данной конфигурации — неполные таблицы маршрутизации, что приводит нас к еще одному типу сетей OSPF. С зоной 34 проблем нет — один из маршрутизаторов с интерфейсом в этой зоне, также имеет физический интерфейс в основной зоне (R3).  
Но в зоне 4 нет ни одного маршрутизатора с интерфейсом в зоне 0. Значит нужно сконфигурировать логическое соединение с зоной 0 — _virtual link_.  
Так как у маршрутизатора R3 есть интерфейс в зоне 0, запуск виртуального канала между R3 и R4 позволит достичь полной связности в сети. Проблема в том, что у R1 нет маршрута до петлевого интерфейса R4, несмотря на то, что этот интерфейс был включен в OSPF.

    R4: router ospf 1
          network 4.4.4.4 0.0.0.255 area 4
          network 172.23.23.0 0.0.0.31 area 34

    R1#show ip route ospf
          6.0.0.0/32 is subnetted, 1 subnets
    O        6.6.6.6[110/11] via 10.1.1.5, 01:05:45, Eternet0
          172.23.0.0/27 is subnetted, 1 subnets
    O IA     172.23.23.0[110/74] via 172.12.123.3, 00:04:14, Serail0
          7.0.0.0/32 is subnetted, 1 subnets
    O        7.7.7.7[110/11] via 10.1.1.5, 01:05:45, Ethernet0

  
Зона, через которую проходит виртуальный канал называется транзитной (_transit area_), она не может быть stub-зоной любого типа (stub, total stub, nssa) (Если вас раздражают все эти названия — не беспокойтесь, в данном курсе впереди еще будет много информации по ним!).   
Вот команды для создания виртуального канала:

    R4(config)#router ospf 1
    R4(config-router)#area 34 virtual link 3.3.3.3

  
Виртуальные каналы должны быть сконфигурированы на обоих концах транзитной зоны. Сейчас перейдем к R3 и завершим конфигурацию.

    R3(config)#router ospf 1
    2d07h: %OSPF-4-ERRRCV: Recieved invalid packet: mismatch area ID, from backbone
    area must be virtual-link but not found from 172.23.23.4 Ethernet0
    R3(config)#router ospf 1
    R3(config-router)#area 34 virtual-link 4.4.4.4
    R3(config-router)#^Z
    2d07h: %OSPF-5-ADJCHG: Process 1, Nbr 4.4.4.4 on OSPF_VLo from LOADING to
    FULL, Loading Done

  
И еще несколько деталей…  
\--Команда _virtual link_ использует RID удаленного устройства, не обязательно IP адрес интерфейса, находящегося в транзитной зоне. Следите за этим — это очень распространенная ошибка. Проверяйте RID!  
\--Также не беспокойтесь насчет сообщений об ошибках в выводе команд R3, это нормально, вы будете видеть такие сообщения пока не закончите настраивать виртуальный канал. А вот если сообщения об ошибках появляются _после_ настройки — то у вас проблема.  
Всегда проверяйте виртуальный канал командой _show ip ospf virtual-link_. Если все настроено правильно, то он должен подняться за секунды.

    R3#show ip ospf virtual-link
    Virtual Link OSPF_VLo to router 4.4.4.4 is up
      Run as demand circuit
      DoNotAge LSA allowed.
      Transit area 34, via interface Ethernet0, Cost of using 10
      Transmit Delay is 1 sec, State POINT_TO_POINT
      Timer intervals configured, Hello 10, Dead 40, Wait 40, Retransmit 5
         Hello due in 00:00:00
         Adjacency State FULL (Hello supressed)
         Index 2/4, retransmission queue length 1, number of retransmition 1
         First 0x2C8F8E(15)/0x0(0) Next 0x2C8F8E(15)/0x0(0)
         Last retransmission scan length is 1, maximum is 1
         Last retramsmission scan time is 0 msec, maximum is 0 msec
         Link State retransmission due in 3044 msec

  
Виртуальные каналы просто настраивать, но по какой-то причине они пугают людей. По моему опыту, сообщение об ошибке, как для маршрутизатора R3, вызывает панику, но все, что значит такое сообщение — только то, что настройка виртуального канала не закончена.  
Знания _рассеивают_ страх и панику.  
99% ошибок при настройке виртуального канала вызывают следующие действия:  
\--использование неправильного значения RID  
\--попытка использовать stub-зону в качестве транзитной  
\--**ошибка при настройке аутентификации для виртуального канала, в случае, когда зона 0 использует аутентификацию.**  
Этот третий случай выделен специально. Последнее всегда забывается! Виртуальный канал — это расширение зоны 0, и если зона 0 использует аутентификацию, она должна быть настроена и для виртуального канала тоже.  
В этом разделе мы рассмотрели много команд OSPF, но не забывайте вашего старого друга — _show ip protocols_. Безотносительно типа сети, эта команда покажет вам маршрутизируемые сети, информацию об аутентификации для канала, и многое другое. Это замечательная команда для начала устранения проблем для любого протокола маршрутизации.

    R3#show ip protocols
    Routing Protocol is "ospf 1"
      Outgoing update filter list for all interfaces is not set
      Incoming update filter list for all interfaces is not set
      Router ID 3.3.3.3
      It is an area border router
      Number of areas in this router is 3. 3 normal 0 stub 0 nssa
      Maximum path: 4
      Routing for networks:
          172.12.13.0  0.0.0.31  area 13
          172.12.123.0  0.0.0.255 area 0
          172.23.23.0  0.0.0.31 area 34
      Routing Information Sources:
         Gateway       Distance         Last Update
         4.4.4.4            110         00:28:41
         8.8.8.8            110         00:28:41
         1.1.1.1            110         00:28:41
         3.3.3.3            110         00:35:30
      Distance: (default is 110)

[1]: https://habrastorage.org/files/d79/ee0/8bc/d79ee08bc1da4f1dae09ce7bf4657fb5.png
[2]: https://habrastorage.org/files/6b8/59f/ff5/6b859fff55154b3a85f7088facc4f4a3.png
[3]: https://habrastorage.org/files/44a/d43/e64/44ad43e6471042bbadaae4d94fb57ccf.png
[4]: https://habrastorage.org/files/f7f/c55/19b/f7fc5519b43c4bb7b2fb533e862bd96f.png
[5]: https://habrastorage.org/files/aec/b02/09d/aecb0209df704189b967612bc496a0c9.png
[6]: https://habrastorage.org/files/461/391/9ed/4613919edfa54cb4926ae22d9fec5b09.png
[7]: https://habrastorage.org/files/5d0/7fc/599/5d07fc599d174a9598551ed4ba1b5e22.png
[8]: https://habrastorage.org/files/982/82b/c68/98282bc68ffd4b188c74ac0bc2b02363.png
[9]: https://habrastorage.org/files/6da/89e/ed1/6da89eed1dfb4598bdef0ea6e1182b2d.png
[10]: https://habrastorage.org/files/0bf/8e3/377/0bf8e33775d44ee785923a6777127a7d.png
[11]: https://habrastorage.org/files/5f5/f68/5b1/5f5f685b134f4bb2a7c0be6d8948c176.png