
# Протоколы состояния канала и однозоновый OSPF (часть 1)

### Основы протоколов состояния канала

Вы знакомы с поведением протоколов состояния канала из курса CCNA, но сейчас мы собираемся пересмотреть важные моменты.

_Избегайте соблазна пропустить обзор._

А пока совсем немногое вам будет знакомо — есть множество дополнительных деталей, которыми вы должны овладеть как CCNP. Для тех, кто собирается сдавать CCIE, нужно по-настоящему освоить принцип работы OSPF.

Когда RIP посылает обновления маршрутов, они содержат полную таблицу маршрутизации. Включая отладку командой _debug ip rip_, вы можете увидеть маршруты, содержащиеся в обновлении вместе с метрикой.

Протоколы состояния канала работают по-другому. Маршрутизаторы состояния канала, которые сформировали соседство, обмениваются пакетами LSU, которые содержат анонсы LSA. Эти анонсы LSA несут информацию о масках подсетей и позволяют OSPF поддерживать маски переменной длины (VLSM).

LSA анонсы помещаются в базу данных состояния канала. Алгоритм Дейкстры (также известный как алгоритм поиска первого кратчайшего пути, SPF) работает с содержимым этой базы данных для создания таблицы маршрутизации OSPF.

Маршрутизаторы должны синхронизировать свои базы данных состояния канала.

Для просмотра содержимого базы данных состояния канала введите команду _show ip ospf database_. Эта команда показывает каналы и типы соединений, порядковые номера и как давно был получен определенный анонс LSA. Это значение в секундах можно посмотреть в колонке «age».

Алгоритм Дейкстры работает с содержимым базы данных…

    R1#show ip ospf database
         OSPF router with ID (1.1.1.1) (Process ID 1)
    Link ID     ADV Router     Age     Seq#          Checksum
    1.1.1.1     1.1.1.1        1286    0x80000006    0x0057A7
    8.8.8.8     8.8.8.8        795     0x8000000C    0x00085E
         Net Link States (Area 0)
    Link ID     ADV Router     Age     Seq#          Checksum
    10.1.1.5    8.8.8.8        795     0x80000006    0x001CC3

  
… вычисляет маршруты, и эти маршруты помещаются в таблицу маршрутизации OSPF

    R1#show ip route ospf
    	6.0.0.0/32 is subnetted, 1 subnets
    O       6.6.6.6[110/11] via 10.1.1.5, 02:32:53, Ethernet0
    	7.0.0.0/32 is subnetted, 1 subnets
    O       7.7.7.7[110/11] via 10.1.1.5, 02:32:53, Ethernet0

  
Алгоритм SPF на самом деле вычисляет кратчайший путь вдоль дерева, и это дерево используется для создания таблицы маршрутизации. Больше об этом алгоритме задумываться не следует, так как он делает все замечательно и без нашего вмешательства, но у нас есть куча деталей, на которые стоит обратить внимание!

### Порядковые номера LSA
  
Для того чтобы убедиться, что маршрутизаторы OSPF получают самую последнюю информацию, LSA присваиваются порядковые номера. Когда маршрутизатор с OSPF получает LSA, он проверяет по своей базе данных, есть ли в ней запись для данного канала или нет.

Если записи нет, то маршрутизатор создает ее и рассылает данный анонс LSA по всем OSPF-интерфейсам, кроме того, на котором было получено это сообщение.

Если запись есть, то возможно несколько вариантов. В зависимости от значения порядкового номера LSA — больше, меньше или равен он содержащемуся в базе данных.

\--Если номер совпадает, анонс LSA игнорируется и никаких действий больше не предпринимается.

\--Если номер меньше, маршрутизатор проигнорирует обновление и передаст пакет LSU, содержащий данный анонс LSA, обратно отправителю. В этой ситуации, маршрутизатор с более свежей информацией сообщает отправителю: «Информация, которую вы отправляете, устарела. Вот та, что следует рассылать.»

\--Если порядковый номер больше, маршрутизатор добавит этот анонс LSA в свою базу данных и отправит подтверждение (LSAcknowledgement). Затем маршрутизатор будет рассылать этот анонс LSA и запустит алгоритм SPF для обновления собственной таблицы маршрутизации.

### Когда происходит обмен анонсами LSA?
  
Дистанционно-векторные протоколы отправляют обновления регулярно через определенный интервал времени, безотносительно того, были изменения в топологии сети или нет. Для стабильной сети это напрасная трата ресурсов. После первоначального обмена анонсами LSA между двумя соседями OSPF, другого обмена анонсами не происходит, пока не изменится топология сети.

Маршрутизатор OSPF также рассылает суммарные анонсы LSA каждые 30 минут.

До обмена анонсами LSA, маршрутизаторы должны стать соседями, формируя соседство. Для этого у маршрутизаторов должны совпадать номер зоны, hello- и dead-таймеры и нужно проверить является ли зона «stub»-зоной. Если есть аутентификация, то она должна быть сконфигурирована на обеих сторонах канала.

Номер самого процесса OSPF локально значим и не влияет на процесс установления соседства.

Для проверки соседства, введите команду _show ip ospf neighbor_ или менее употребительную _show ip ospf interface_. Эту последнюю команду часто забывают, но она дает много полезной информации.

Заметьте, что обе команды покажут вам какие отношения соседства существуют, и только _show ip ospf neighbor_ покажет статус загрузки базы данных (FULL, 2WAY, и т.д.)

    R3#show ip ospf neighbor

    Neighbor ID   Pri   State      Dead Time    Address       Interface
    1.1.1.1       1     FULL/DR    00:01:52     172.12.123.1  Serial0
    1.1.1.1       1     FULL/ -    00:00:32     172.12.13.1   Serial1
    4.4.4.4       1     FULL/DR    00:00:32     172.23.23.4   Ethernat0

    R3#show ip ospf interface serial0
    Serial0 is up, line protocol is up
    	Internet address 172.12.123.3/24, Area0
    	Process ID 1, Router ID 3.3.3.3, Network Type NON_BROADCAST, Cost: 64
    	Transmit Delay is 1 sec, State DROTHER, Priority 0
    	Designated Router (ID) 1.1.1.1, Interface Address 172.12.123.1
    	No backup designated router on this network
    	Timer intervals configured, Hello 30, Dead 120, Wait 120, Retransmit 5
    	  Hello due in 00:00:16
    	Index 1/1, flood queue length 0
    	Next 0x0(0)/0x0(0)
    	Last flood scan length is 1, maximum is 3
    	Last flood scan time is 0 msec, maximum is 4 msec
    	Neighbor count is 1, Adjacent neighbor count is 1
    	  Adjacent with Neighbor 1.1.1.1 (Designated Router)
    	  Supress Hello for 0 neighbor(s)

  
_show ip ospf interface_ даст вам локальный идентификатор маршрутизатора OSPF (RID), его роль в данном сегменте (DR, BDR, DROther), идентификатор (RID) DR или BDR для данного сегмента и многое другое. Это замечательный отправной пункт для устранения проблем.

### Роль DR и BDR
  
Главный недостаток дистанционно-векторных протоколов — медленная конвергенция.

_Конвергенция_ означает состояние сети, когда каждый маршрутизатор имеет подобное другим маршрутизаторам и точное представление о сети, особенно после изменения топологии, как, например, при отключенном маршруте. Дистанционно-векторные протоколы не конвергируют достаточно быстро, что может привести к неоптимальной маршрутизации и маршрутным петлям.

Протоколы состояния канала конвергируют почти сразу после изменения топологии. OSPF использует выделенные маршруты и запасные выделенные маршруты для быстрой и правильной конвергенции в сети.

### Как DR рассылают сообщения об изменениях в сети

  
Когда маршрутизатор в OSPF сегменте с DR и BDR замечает изменения в сети, он не уведомляет всех соседей. Вместо этого он отправляет мультикаст на 224.0.0.6, адрес, который слушают оба маршрутизатора — DR и BDR, чтобы знать о таких изменениях.

Затем DR отправляет мультикаст на 224.0.0.5 — уведомить все не-DR и не-BDR маршрутизаторы в сети. (Маршрутизаторы, которые не являются DR или BDR, называются DROthers, как показано в выводе команды _show ip ospf neighbor_). DROther-ы отправляют подтверждение (LSAcknowledgment, LSAck) обратно DR о получении обновления.

Два замечания:

\--Только DR и BDR слушают 224.0.0.6.

\--Только DR отправляет мультикаст на 224.0.0.5 для уведомления DROthers об изменениях в сети. BDR получают их, но не уведомляют другие маршрутизаторы. Прослушивание 224.0.0.6 дает BDR возможность иметь последние изменения в базе данных — и это важно на тот случай, если он станет DR.

### Процесс выбора DR/BDR
  
_Почти_ каждый сегмент сети OSPF содержит DR и BDR. Как всегда имеются исключения, и мы обсудим эти ситуации далее. А сейчас, давайте взглянем поближе на правила выбора DR и BDR.

Согласно следующей диаграмме сети (я мог бы поместить в центр коммутатор вместо обозначения сегмента «Ethernet»; будьте готовы встретить такое в сетевой документации).

![][1]

Интерфейсы четырех маршрутизаторов находятся в сегменте Ethernet. Один станет DR, другой BDR, остальные — DROthers. Перед тем как увидеть, как маршрутизаторы Cisco распределяют эти роли, давайте взглянем на процесс выбора DR/BDR.

1\. Все маршрутизаторы с приоритетом интерфейса 1 или выше могут быть выбранными в качестве DR/BDR. Установка приоритета в 0 лишает маршрутизатор такой возможности.

2\. Маршрутизатор с наибольшим приоритетом становится DR.

3\. Если они совпадают, то сравниваются значения идентификатора RID. Маршрутизатор с наибольшим — выигрывает.

4\. Этот процесс повторяется для выбора нового BDR. Один и тот же маршрутизатор не может быть одновременно DR и BDR.

Позже мы обсудим интересное поведение DROthers в сегменте Ethernet. А сейчас сфокусируемся на процессе выбора DR/BDR с использованием OSPF RID.

### Процесс выбора с OSPF RID

Очевидно, OSPF RID играет большую роль в выборе DR и BDR — но как определяется значение RID? По следующим правилам:

OSPF RID маршрутизатора будет наибольший IP адрес, назначенный loopback-интерфейсу, безотносительно был ли этот интерфейс включен в процесс OSPF. Он не анонсируется автоматически OSPF.

Если нет петлевых (loopback) интерфейсов, OSPF RID маршрутизатора будет наибольшее значение IP адреса, назначенного физическому интерфейсу, безотносительно включен он в OSPF ли нет.

Эти правила могут быть переписаны установкой OSPF RID вручную командой _router-id_, но на маршрутизаторе должен быть перезапущен процесс OSPF (cleared).

Кажется немного странным, что петлевые интерфейсы, не участвующие в OSPF, определяют RID, не так ли?  
Давайте посмотрим на все в действии. R1 и R5 сформировали соседство в подсети 10.1.1.0/24. У R5 есть несколько петлевых интерфейсов, но анонсируются через OSPF только два:

    hostname R5
    !
    interface Loopback6
     ip address 6.6.6.6 255.255.255.255
    !
    interface Loopback7
     ip address 7.7.7.7 255.255.255.255
    !
    interface Loopback8
     ip address 8.8.8.8 255.255.255.255
    !
    interface Ethernet0
     ip address 10.1.1.5 255.255.255.0
    !

    router ospf 1
     network 6.6.6.6 0.0.0.0 area 0
     network 7.7.7.7 0.0.0.0 area 0
     network 10.1.1.0 0.0.0.255 area 0

  
Зная правила определения OSPF RID, какой OSPF RID покажет R1 для R5? Посмотрите на конфигурацию и выясните.

Если вы сказали 8.8.8.8, то вы правы. Чтобы увидеть OSPF RID соседа надо ввести _show ip ospf neighbor_:

    R1#show ip ospf neighbor
    Neighbor ID   Pri   State      Dead Time    Address       Interface
    8.8.8.8       1     FULL/DR    00:00:37     10.1.1.5      Ethernet0
  
Значение, указанное под _Neighbor ID_ это RID соседа.

Для иллюстрации другой важной вещи, касающейся DR и BDR, давайте вернемся к нашему примеру с четырьмя маршрутизаторами. Маршрутизаторы имеют следующие адреса:

    RouterA: Loopback 1.1.1.1, ethernet0 172.1.1.1
    RouterB: Loopback 2.2.2.2, ethernet0 172.1.1.2
    RouterC: No loopback, ethernet0 172.1.1.3
    RouterD: No loopback, ethernet0 172.1.1.4

  
RID будут такими:

    RouterA: 1.1.1.1
    RouterB: 2.2.2.2
    RouterC: 172.1.1.3
    RouterD: 172.1.1.4
  
Процесс выбора RID всегда отдает предпочтение IP адресам петлевых интерфейсов над физическими.

Суммируя сказанное, мы имеем три способа влияния на значение RID:

\--Изменение приоритета OSPF с помощью команды _ip ospf priority_

\--Установка RID вручную при помощи _router-id_

\--Установка RID путем конфигурирования петлевого интерфейса

Ни один из этих способов не является «ошибочным» или «правильным» — так что знайте все три, и знайте, что нужно перезапускать процессы OSPF для применения изменений.

### Что случится, если DR отключится, а затем включится?

Если все четыре маршрутизатора включились одновременно, мы ожидаем, что маршрутизатор D будет DR и маршрутизатор C — BDR. Но что, если маршрутизатор D отключится, а потом включится?

При отсутствии маршрутизатора D, маршрутизатор C становится DR. Маршрутизатор B будет BDR. А затем маршрутизатор D включается, но _маршрутизаторы C и B сохраняют свои роли._

Это не похоже на протокол связующего дерева, где новый коммутатор, с меньшим BID становится корневым. В OSPF выбор DR/BDR не меняется при включении нового маршрутизатора или включении того, который ранее был DR или BDR.

Давайте рассмотрим пример с тремя маршрутизаторами в сегменте Ethernet. Приоритет маршрутизатора A — 100, B — 50, C — 10. Маршрутизатор A выбран DR, B — BDR.

![][2]

Все хорошо, пока не выключается маршрутизатор A. Маршрутизаторы B и C становятся соответственно DR и BDR.

![][3]

Включение маршрутизатора A — не причина перевыбирать DR/BDR, даже если приоритет маршрутизатора A выше, чем у DR и BDR. При включении маршрутизатор A становится DROther.

![][4]

Чтобы маршрутизатор A стал вновь DR, оба текущих DR и BDR должны отключиться! Что произойдет, когда отключится маршрутизатор B?

![][5]

Маршрутизатор C становится DR, маршрутизатор A — BDR. При включении маршрутизатора B он будет DROther.

![][6]

Для окончательной установки в качестве DR маршрутизатора A отключаем маршрутизатор C. Теперь маршрутизатор A из BDR станет DR, а маршрутизатор B — BDR.

![][7]

При включении маршрутизатора C он станет DROther, и мы получим прежнюю схему сети!

![][2]  

### Типы сетей OSPF

### Почему типы сетей OSPF важны
  
По умолчанию тип сети OSPF зависит от типа сегмента сети. Различные типы сетей OSPF имеют различные значения hello- и dead- таймеров, и это одни из значений, которые должны совпадать для установления соседства между двумя маршрутизаторами. Кроме того, некоторые типы сетей OSPF не имеют DR и BDR, а у других есть особые условия, которые необходимо соблюдать.

Кроме того, они все одинаковые, правильно? :)

Не беспокойтесь, мы рассмотрим каждый тип сети OSPF, необходимый для сдачи экзамена CСNP ROUTE!

Если не указано иное, сегмент сети находится в зоне 0 — основной зоне.

Адрес подсети широковещательной сети — 10.1.1.0/24. Последний октет каждого IP адреса будет номером маршрутизатора. Каждый маршрутизатор имеет петлевой интерфейс, с номером маршрутизатора в каждом октете. (Петлевой интерфейс для R1 — 1.1.1.1/32 и т.д.)

### Широковещательная сеть OSPF

  
![][8]  
Конфигурация OSPF в сегменте Ethernet для широковещательной сети будет оставлена по-умолчанию, также будут выбраны DR и BDR, для влияния на выбор DR/BDR можно использовать команду _ip ospf priority_.

Для большого сегмента сети хорошая идея использовать мощные маршрутизаторы для выполнения этих ролей (DR/BDR), так как это влечет за собой нагрузку на CPU. Как всегда, все, что мы делаем на маршрутизаторе имеет свою цену.

Вывод команды _show ip ospf interface ethernet0_ на маршрутизаторе R1 показывает нам тип сети, а также много другой информации. Заметьте, значения по-умолчанию hello- и dead- таймеров широковещательной сети — 10 и 40 секунд соответственно. По-умолчанию dead time равен четырехкратному hello time.

    R1#show ip ospf interface ethernet0
    Ethernet0 is up, line protocol is up
      Internet Address 10.1.1.1/24, Area 0
      Process ID 1, Router ID 1.1.1.1, Network Type BROADCAST, Cost: 10
      Transmit Delay is 1 sec, State BDR, Priority 1
      Designated Router (ID) 8.8.8.8, Interface address 10.1.1.5
      Backup Designated Router (ID) 1.1.1.1, Interface address 10.1.1.1
      Timer Intervals configured, Hello 10, Dead 40, Wait 40, Retransmit 5
         Hello due in 00:00:04
      Index 1/1, flood queue length 0

    Next 0x0(0)/0x0(0)
    Last flood scan length is 1, maximum is 2
    Last flood scan time is 0 msec, maximum is 4 msec
    Neighbor Count is 1, Adjacent neighbor count is 1
      Adjacent  with neighbor 8.8.8.8 (Designated Router)
    Supress hello for 0 neighbor(s)

  
Для широковещательного сегмента _не обязательно_ делать определенный маршрутизатор DR или BDR, но для нашего следующего примера это не так.

### Сеть OSPF NBMA

  
Сейчас мы добавим еще сегмент к существующей сети, на frame relay. Новый сегмент использует адрес 172.12.123.0/24. От R1 идет два канала PVC до R2 и R3; между «спицами»(spoke) PVC нет. Интерфейс Serial0 каждого маршрутизатора находится в зоне 0.   
![][9]  
Последовательные интерфейсы в этом новом сегменте по-умолчанию будут нешироковещательными с множественным доступом (NBMA). Так как узлы сети не образуют полносвязную сеть, хаб-маршрутизатор R1 должен быть DR и здесь может не быть BDR.  
Почему? У DR и любого потенциального BDR должна быть возможность получать мультикаст от всех остальных маршрутизаторов в сети. В топологии «звезда» у spoke-маршрутизатора нет возможности получать широковещательный или мультикаст трафик от другого spoke-маршрутизатора, так как весь трафик проходит через хаб — а маршрутизаторы не перенаправляют широковещательный или мультикаст трафик!  
Перед настройкой любой OSPF конфигурации поверх frame relay, убедитесь, что опция _broadcast_ у вас включена!  
Иначе OSPF пакеты не будут передаваться через frame relay.

    R1(config-if)#frame map ip 172.12.123.2 122 broadcast
    R1(config-if)#frame map ip 172.12.123.3 123 broadcast

    R1#show frame map
    Serial0(up): ip 172.12.123.2 dlci 122(0x7A,0x1CA0),static,
                 broadcast,
                 CISCO, status defined, active
    Serial0(up): ip 172.12.123.3 dlci 123(0x7B,0x1CB0),static,
                 broadcast,
                 CISCO, status defined, active

  
Недостаточно просто убедиться, что R1 стал DR — мы должны предотвратить возможность становления DR/BDR для R2 и R3! Для этого изменим приоритет со значения по-умолчанию (1) на 0.

    R2(config)#int s0
    R2(config-if)#ip ospf priority 0

    R3(config)#int s0
    R3(config-if)#ip ospf priority 0

  
Маршрутизатор с наибольшим значением приоритета интерфейса, на котором включен OSPF, становится DR. Если значения приоритета равны, то сравниваются идентификаторы маршрутизаторов (RID), выигрывает — наибольший.  
Фактически, мы мошенничаем с выбором DR, не оставляя шансов для spoke-маршрутизаторов, даже при исчезновении хаба! Установка приоритета в 0 для spoke-маршрутизаторов не оставляет им возможности стать DR в случае перезагрузки хаб-маршрутизатора.  
«NB» в слове NBMA означает «нешироковещательный», так что при конфигурировании хаб-маршрутизатора нужно вручную указывать соседей, как показано ниже. Для spoke-маршрутизаторов такое не требуется.

    R1#conf t
    Enter configuration commands, one per line. End with CTRL+Z. R1(config)#router ospf 1
    R1(config-router)#network 172.12.123.0 0.0.0.255 area 0
    R1(config-router)#neighbor 172.12.123.2
    R1(config-router)#neighbor 172.12.123.3

    R1#show ip ospf interface serial0
    Serial0 is up, line protocol is up
      Internet Address 172.12.123.1/24, Area 0
      Process ID 1, Router ID 1.1.1.1, Network Type NON_BROADCAST, Cost: 64
      Transmit Delay is 1 sec, State DR, Priority 1
      Designated Router (ID) 1.1.1.1, Interface address 172.12.123.1
    No backup designated router on this network
      Timer intervals configured, Hello 30, Dead 120, Wait 120, Retransmit 5
        Hello due to 00:00:11
      Index 2/2, flood queue length 0
      Next 0x0(0)/0x0(0)
      Last flood scan length is 1, maximum is 2
      Last flood scan time is 4 msec, maximum is 4 msec
      Neighbor Count is 2, Adjacent neighbor count is 2
        Adjacent with neighbor 3.3.3.3
        Adjacent with neighbor 2.2.2.2
      Supress hello for 0 neighbor(s)

  
У вас может быть сеть NBMA c DR и BDR, но они оба должны быть хаб-маршрутизаторами. Сеть с двумя хабами может использовать один как DR, другой как BDR. Каждый DR или BDR должен иметь статически настроенных соседей; такая настройка не нужна на других маршрутизаторах. (Если у вас много хаб-маршрутизаторов, один из них может быть BDR).  
Заметьте, hello- и dead- таймеры равны 30 и 120 соответственно. Dead-таймер снова в четыре раза больше, чем hello.  
Последовательные интерфейсы по-умолчанию NBMA, но вы можете изменить тип сети OSPF интерфейса командой _ip ospf network_.

    R1(config-if)#ip ospf network ?
      broadcast              Specify OSPF broadcast multi-access network
      non-broadcast          Specify OSPF NBMA network
      point-to-multipoint    Specify OSPF point-to-multipoint network
      point-to-point    Specify OSPF point-to-point network

  

### Типы сетей OSPF Point-To-Point и Point-To-Multipoint

  
Сейчас мы добавим прямое соединение между R1 и R3, но расположим его в зоне 13. Номер подсети 172.12.13.0/27. Интерфейсы Serial1 обоих маршрутизаторов находятся в этой зоне 13.  
![][10]  
Все non-backbone зоны должны иметь маршрутизатор с логическим или физическим интерфейсом в основной зоне 0. В зоне 13 два таких маршрутизатора, так что конфигурация правильная.  
_show ip ospf interface serial1_ покажет данный сегмент OSPF по-умолчанию для типа сети OSPF point-to-point. Этот вывод показывает также по-умолчанию hello- и dead- таймеры для данного типа сети — 10 и 40 секунд соответственно.

    R1#show ip ospf interface serial1
    Serial1 is up, line protocol is up
      Internet Address 172.12.13.3/27, Area 13
      Process ID 1, Router ID 3.3.3.3, Network Type POINT_TO_POINT, Cost: 64
      Transmit Delay is 1 sec, State POINT_TO_POINT,
      Timer intervals configured, Hello 10, Dead 40, Wait 40, Retransmit 5
        Hello due to 00:00:08
      Index 1/2, flood queue length 0
      Next 0x0(0)/0x0(0)
      Last flood scan length is 1, maximum is 1
      Last flood scan time is 0 msec, maximum is 0 msec
      Neighbor Count is 1, Adjacent neighbor count is 1
        Adjacent with neighbor 1.1.1.1
      Supress hello for 0 neighbor(s)

  
Заметьте, что в списке нет DR и BDR. В канале «точка-точка» только два маршрутизатора. Следовательно, нет необходимости даже иметь DR или BDR, и ни один маршрутизатор не будет выбран в качестве таковых.  
_show ip ospf neighbor_ показывает прочерки на месте, где обычно указана роль соседа. Процесс выбора DR/BDR опускается в point-to-point и point-to-multipoint сетях. Команда neighbor обычно не нужна в этих сетях. Ниже R3 видит R1 как DR в сети NBMA, тогда как он же без роли видим в сети point-to-point.

    R3#show ip ospf neighbor
    Neighbor ID   Pri State      Dead Time     Address       Interface
    1.1.1.1         1 FULL/DR    00:01:46      172.12.123.1  Serial0
    1.1.1.1         1 FULL/-     00:00:35      172.12.13.1   Serial1

  
Прочерк после FULL/ показывает, что сосед не является ни DR, ни BDR, ни DROther, что означает, что процесса выбора DR/BDR не было. Вы увидите подобную ситуацию в _OSPF сети point-to-multipoint_, что OSPF воспринимает, как набор каналов point-to-point.  
Например, мы можем вернуться и изменить конфигурацию OSPF сети frame relay как сети point-to-multipoint командой _ip ospf network point-to-multipoint_ на последовательном интерфейсе маршрутизатора R1. DR/BDR выбраны не будут и команда neighbor не нужна.  
Теперь сеть OSPF типа point-to-multipoint предлагает два варианта — широковещательная и нет.

### Конфигурация широковещательной OSPF сети Point-To-Multipoint

  
Этот тип сети не требует команды _neighbor_, но вы можете определить стоимость для данного соседа.

    R1#ip ospf network point-to-multipoint ?
       non-broadcast     Specify non-broadcast point-to-multipoint network
       

  
Заметьте, что опция _broadcast_ отсутствует, так как по-умолчанию сети типа point-to-multipoint — широковещательные.

    R1(config-if)#router ospf 1
    R1(config-router)#neighbor 172.12.123.2 ?
               cost            OSPF cost for point-to-multipoint neighbor
               database-       Filter OSPF LSA during synchronization and flooding for point-to-multipoint
               filter          neighbor
               poll-interval   OSPF dead-router polling interval
               priority        OSPF priority of non-broadcast neighbor
               

    R1(config-router)#neighbor 172.12.123.2 cost ?
       <1-65535>   metric
    R1(config-router)#neighbor 172.12.123.2 cost 20

  

### Нешироковещательная OSPF сеть Point-To-Multipoint

  
С другой стороны, в нешироковещательной сети point-to-multipoint команда _neighbor_ требуется. Вы можете добавить стоимость для соседа, но соседи _должны_ быть статически определены для данного типа сети.

    R1(config-if)#ip ospf network point-to-multipoint non-broadcast

    R1(config-router)#neighbor 172.12.123.2 cost 15
    R1(config-router)#neighbor 172.12.123.3 cost 25

  

### Запуск широковещательных OSPF сетей над топологией NBMA

  

### То, что вы можете что-то сделать, не означает, что вы должны это делать!

  
Нам следует использовать команду _ip ospf network broadcast_ на всех маршрутизаторах сети frame relay, и, так как сеть полносвязная, технически все должно работать и маршрутизаторы будут вести себя так, как если бы были в LAN сети.  
В реальной жизни использование широковещательной OSPF сети в сегменте NBMA может привести к непредсказуемым результатам, и лично я не стал бы так делать.  
Зачем тратить время на устранение проблем, когда можно придерживаться настроек по-умолчанию?

### Виртуальный канал (virtual link) OSPF

  
Настройки OSFP сети, запущенной через frame relay, были восстановлены до значений по-умолчанию для сети типа NBMA и останутся таковыми до конца данного раздела.  
Сейчас мы добавим маршрутизатор R4 в нашу сеть. R4 и R3 будут соседями через зону 34, у R4 будет петлевой интерфейс в зоне 4. Адрес подсети для сегмента между R3 и R4 — 172.12.34.0/24, сегмент ethernet.  
![][11]

Результат данной конфигурации — неполные таблицы маршрутизации, что приводит нас к еще одному типу сетей OSPF. С зоной 34 проблем нет — один из маршрутизаторов с интерфейсом в этой зоне, также имеет физический интерфейс в основной зоне (R3).  
Но в зоне 4 нет ни одного маршрутизатора с интерфейсом в зоне 0. Значит нужно сконфигурировать логическое соединение с зоной 0 — _virtual link_.  
Так как у маршрутизатора R3 есть интерфейс в зоне 0, запуск виртуального канала между R3 и R4 позволит достичь полной связности в сети. Проблема в том, что у R1 нет маршрута до петлевого интерфейса R4, несмотря на то, что этот интерфейс был включен в OSPF.

    R4: router ospf 1
          network 4.4.4.4 0.0.0.255 area 4
          network 172.23.23.0 0.0.0.31 area 34

    R1#show ip route ospf
          6.0.0.0/32 is subnetted, 1 subnets
    O        6.6.6.6[110/11] via 10.1.1.5, 01:05:45, Eternet0
          172.23.0.0/27 is subnetted, 1 subnets
    O IA     172.23.23.0[110/74] via 172.12.123.3, 00:04:14, Serail0
          7.0.0.0/32 is subnetted, 1 subnets
    O        7.7.7.7[110/11] via 10.1.1.5, 01:05:45, Ethernet0

  
Зона, через которую проходит виртуальный канал называется транзитной (_transit area_), она не может быть stub-зоной любого типа (stub, total stub, nssa) (Если вас раздражают все эти названия — не беспокойтесь, в данном курсе впереди еще будет много информации по ним!).   
Вот команды для создания виртуального канала:

    R4(config)#router ospf 1
    R4(config-router)#area 34 virtual link 3.3.3.3

  
Виртуальные каналы должны быть сконфигурированы на обоих концах транзитной зоны. Сейчас перейдем к R3 и завершим конфигурацию.

    R3(config)#router ospf 1
    2d07h: %OSPF-4-ERRRCV: Recieved invalid packet: mismatch area ID, from backbone
    area must be virtual-link but not found from 172.23.23.4 Ethernet0
    R3(config)#router ospf 1
    R3(config-router)#area 34 virtual-link 4.4.4.4
    R3(config-router)#^Z
    2d07h: %OSPF-5-ADJCHG: Process 1, Nbr 4.4.4.4 on OSPF_VLo from LOADING to
    FULL, Loading Done

  
И еще несколько деталей…  
\--Команда _virtual link_ использует RID удаленного устройства, не обязательно IP адрес интерфейса, находящегося в транзитной зоне. Следите за этим — это очень распространенная ошибка. Проверяйте RID!  
\--Также не беспокойтесь насчет сообщений об ошибках в выводе команд R3, это нормально, вы будете видеть такие сообщения пока не закончите настраивать виртуальный канал. А вот если сообщения об ошибках появляются _после_ настройки — то у вас проблема.  
Всегда проверяйте виртуальный канал командой _show ip ospf virtual-link_. Если все настроено правильно, то он должен подняться за секунды.

    R3#show ip ospf virtual-link
    Virtual Link OSPF_VLo to router 4.4.4.4 is up
      Run as demand circuit
      DoNotAge LSA allowed.
      Transit area 34, via interface Ethernet0, Cost of using 10
      Transmit Delay is 1 sec, State POINT_TO_POINT
      Timer intervals configured, Hello 10, Dead 40, Wait 40, Retransmit 5
         Hello due in 00:00:00
         Adjacency State FULL (Hello supressed)
         Index 2/4, retransmission queue length 1, number of retransmition 1
         First 0x2C8F8E(15)/0x0(0) Next 0x2C8F8E(15)/0x0(0)
         Last retransmission scan length is 1, maximum is 1
         Last retramsmission scan time is 0 msec, maximum is 0 msec
         Link State retransmission due in 3044 msec

  
Виртуальные каналы просто настраивать, но по какой-то причине они пугают людей. По моему опыту, сообщение об ошибке, как для маршрутизатора R3, вызывает панику, но все, что значит такое сообщение — только то, что настройка виртуального канала не закончена.  
Знания _рассеивают_ страх и панику.  
99% ошибок при настройке виртуального канала вызывают следующие действия:  
\--использование неправильного значения RID  
\--попытка использовать stub-зону в качестве транзитной  
\--**ошибка при настройке аутентификации для виртуального канала, в случае, когда зона 0 использует аутентификацию.**  
Этот третий случай выделен специально. Последнее всегда забывается! Виртуальный канал — это расширение зоны 0, и если зона 0 использует аутентификацию, она должна быть настроена и для виртуального канала тоже.  
В этом разделе мы рассмотрели много команд OSPF, но не забывайте вашего старого друга — _show ip protocols_. Безотносительно типа сети, эта команда покажет вам маршрутизируемые сети, информацию об аутентификации для канала, и многое другое. Это замечательная команда для начала устранения проблем для любого протокола маршрутизации.

    R3#show ip protocols
    Routing Protocol is "ospf 1"
      Outgoing update filter list for all interfaces is not set
      Incoming update filter list for all interfaces is not set
      Router ID 3.3.3.3
      It is an area border router
      Number of areas in this router is 3. 3 normal 0 stub 0 nssa
      Maximum path: 4
      Routing for networks:
          172.12.13.0  0.0.0.31  area 13
          172.12.123.0  0.0.0.255 area 0
          172.23.23.0  0.0.0.31 area 34
      Routing Information Sources:
         Gateway       Distance         Last Update
         4.4.4.4            110         00:28:41
         8.8.8.8            110         00:28:41
         1.1.1.1            110         00:28:41
         3.3.3.3            110         00:35:30
      Distance: (default is 110)

### Почему бы не использовать одну большую зону 0?

После того, как слышишь о важности зоны 0 в 10000 раз, начинаешь думаь: "А почему бы не поместить все маршрутизаторы в одну большую зону 0? В этом случае не придется беспокоиться о плане сети, виртуальных каналах и прочем! В конце концов RIP не использует зоны вообще."

Все правильно, но по той же причине RIP не так уж распространен в глобальных вычислительных сетях. Использование зон OSPF позволяет вам создать _иерархию_.

Звучит здорово, в экзаменах Cisco любят слово "иерархический"..._но что оно означает?_. Вот определение:

_прилагательное: классифицируемый в соответствии с различными критериями в последовательные уровни или слои_.

### Преимущества многозонового OSPF

Зоны OSPF дают вам возможность построить многоуровневую сеть. Это помогает снизить нагрузку на такие ресурсы маршрутизатора как память и ЦПУ. Благодаря такому подходу маршрутизаторам может иногда не понадобиться большая таблица маршрутизации.

Излишне крупные таблицы маршрутизации могут истощить ресурсы маршрутизатора - и если существует только один путь для пакетов от маршрутизатора по различным направлениям - зачем иметь полную таблицу маршрутов, если то же самое делает маршрут по-умолчанию?

У однозонового OSPF есть свои недостатки. Логическое деление сети OSPF на зоны помогает ограничить траффик LSU и LSA, т.к. рассылка уведомлений об измененеиях в сети ограничена зоной. Это позволяет ограничить повторное вычисление таблицы маршрутизации по алгоритму Дейкстры.

Суммируя сказанное, зоны OSPF имеют следущие преимущества:

\-- более эффективная маршрутизация через "полные но краткие" таблицы маршрутизации,
\-- меньше в целом перерасчет по алгоритму SPF,
\-- меньше траффика LSU\LSA и связанных с ним издержек

Говоря о перерасчете таблиц маршрутизации по алгоритму SPF, можно видеть сколько раз он запускался с помощью команды _show ip ospf_. Если вы видите, что это число постоянно возрастает, то значит в зоне OSPF есть нестабильный сегмент. (Тут много текста в выводе команды, но его стоит знать).
<pre>
    R3#show ip ospf
     Routing Process "ospf 1" with ID 3.3.3.3
     Supports only single TOS(TOS0) routes
     Supports opaque LSA
     <b>It is an area border router</b>
     SPF schedule delay 5 secs, Hold time between two SPFs 10 secs
     Minimum LSA interval 5 secs. Minimum LSA arrival 1 secs
     Number of external LSA 0. Checksum Sum 0x000000
     Number of opaque AS LSA 0. Checksum Sum 0x000000
     Number of DCbitless external and opaque AS LSA 0
     Number of DoNotAge external and opaque AS LSA 0
     Number of areas in this router is 3. 3 normal 0 stub 0 nssa
     External flood list length 0
       <b>Area BACKBONE(0)</b>
          <b>Number of interfaces in this area is 2</b>
          <b>Area has no autentication</b>
          <b>SPF algorithm executed 10 times</b>
          Area ranges are
          Number of LSA 12. Checksum Sum 0x06DBEB
          Number of opaque link LSA 0. Checksum Sum 0x000000
          Number of DCbitless LSA 0
          Number of indication LSA 0
          Number of DoNotAge LSA 3
          Flood list length 0
      <b>Area 13</b>
          <b>Number of interfaces in this area is 1</b>
          <b>Area has no autentication</b>
          <b>SPF algorithm executed 4 times</b>
          Area ranges are
          Number of LSA 14. Checksum Sum 0x0822C6
          Number of opaque link LSA 0. Checksum Sum 0x000000
          Number of DCbitless LSA 0
          Number of indication LSA 0
          Number of DoNotAge LSA 0
          Flood list length 0
      <b>Area 34</b>
          <b>Number of interfaces in this area is 1</b>
          <b>Area has no autentication</b>
          <b>SPF algorithm executed 6 times</b>
          Area ranges are
          Number of LSA 15. Checksum Sum 0x06BDFB
          Number of opaque link LSA 0. Checksum Sum 0x000000
          Number of DCbitless LSA 0
          Number of indication LSA 0
          Number of DoNotAge LSA 0
          Flood list length 0
</pre>
Все это мы подробно рассмотрим в следущей части.

### Определение стоимости пути OSPF

Когда вы смотрите в таблицу маршрутизации OSPF, вы видите два числа в квадратных скобках. Первое число это административная дистания (AD) OSPF, которая равна 110. Второе число - метрика, используемая OSPF, стоимость пути.
<pre>
    R2#show ip route ospf
        1.0.0.0/32 is subnetted, 1 subnets
    O IA  1.1.1.1<b>[110/65]</b> via 172.12.123.1, 2d03h, Serial0
        33.0.0.0/32 is subnetted, 1 subnets
    O IA  33.33.33.33<b>[110/65]</b> via 172.12.123.3, 2d02h, Serial0
        3.0.0.0/32 is subnetted, 1 subnets
    O IA  3.3.3.3<b>[110/65]</b> via 172.12.123.3, 2d03h, Serial0
        15.0.0.0/24 is subnetted, 1 subnets
</pre>

OSPF присваивает стоимость каждому интерфейсу, на котором он разрешен. Стоимость интерфейса зависит от скорости порта. По-умолчанию OSPF использует следующую формулу:

  100,000,000/Bandwidth in bps (NOT kbps!)

В документации вы можете встретить 10^8, но мне кажется, легче запомнить ее как 100 миллионов. Если вам нужно посчитать стоимость вручную, помните о единицах измерения - бит, а не килобит в секунду.

Вот несколько значений по-умолчанию для известных скоростей интерфейсов:

  56 kbps = 1785
  T1 line = 64
  Ethernet = 10
  16 MBPS Token Ring = 6
  FDDI and 100 MBPS Ethernet = 1

При подготовке к CCNA вы выучили, что команда урвня интерфейса _bandwidth_ позволяет присвоить EIGRP более точное значение скорости на последовательном интерфейсе. Эта же команда может использоваться и для OSPF.

Например, если скорость на интерфейсе serial1 маршрутизатора составляет 512 kbps, а не 1544 kbps, то команда _bandwidth_ дает возможность указать более точное значение скорости интерфейса. OSPF выполнит перерасчет стоимости интерфейса почти незамедлительно после ввода данной команды.

Стоимость интерфейса можно увидеть с помощью команды _show ip ospf interface_. Заметьте, стоимость последовательного интерфейса составляет 64, а значит интерфейс подключен к линии T1. Если бы он был подключен к линии со скоростью 512 kbps, команда _bandwidth_ могла быть использована для указания этого, и OSPF сразу бы перерасчитал стоимость интерфейса.

<pre>
  R1#show ip ospf interface serial0
  Serial0 is up? line protocol is up
   Internet Address 172.12.123.1/24, Area 0
   Process ID 1, Router ID 1.1.1.1, Network Type NON_BROADCAST, <b>Cost 64</b>

  R1#conf t
  Enter configuration commands, one per line. End with CNTL/Z.
  <b>R1(config)#interface serial0</b>
  <b>R1(config-if)#bandwidth 512</b>

  R1#show ip ospf interface serial0
  Serial0 is up? line protocol is up
   Internet Address 172.12.123.1/24, Area 0
   Process ID 1, Router ID 1.1.1.1, Network Type NON_BROADCAST, <b>Cost 195</b>
</pre>

Новая скорость интерфейса составляет треть от T1, так что новая стоимость интерфейса примерно равна трем стоимостям по-умолчанию для данного интерфейса.

Предпочтительным является путь с наименьшей стоимостью. Как и RIP, OSPF использует балансировку нагрузки до четырех интерфейсов с равными стоимостями пути по-умолчанию.

Вы можете изменить значение, которое OSPF использует для вычисления стоимости пути. Если у вас действительно _есть_ хорошая причина изменить значение 100,000,000, вы можете использовать команду _ospf auto-cost reference-bandwidth_. Самое забавное, что эта команда требует указания скорости в MBPS:

<pre>
	R2#conf t
	Enter configuration commands? one per line. End with CNTL/Z.
	R2(config)#router ospf 1
	R2(config-router)#auto-cost reference-bandwidth ?
		<1-4294967> The reference bandwidth in terms of Mbits per second
</pre>

Хорошей причиной для такого изменения может стать добавление интерфейсов FastEthernet и GigEthernet в вашу сеть.

### Сравнение OSPF и RIP

OSPF считается лучше RIP, вот несколько причин почему:
\-- метрика OSPF более точна для измерения действительного расстояния до удаленной сети.
\-- в OSPF используется композитная метрика, _стоимость_, тогда в RIP вся метрика основана на числе прыжков.
\-- OSPF не накладывает ограничений, когда сеть "доступна" или "недоступна", тогда как в RIP максимальное число прыжков - 15 для борьбы со счетом до бесконечности.
\-- OSPF поддерживает VLSM, тогда как RIPv1 нет. Хотя в RIPv2 есть поддержка VLSM. Протокол с поддержкой VLSM позволяет более эффективно использовать адресное пространство.
\-- OSPF использует пропускую способность сети более эффективно, чем RIP.
\-- многоадресная рассылка обновлений OSPF происходит только при установлении соседства, изменениях в сети или истечения 30-минутного периода времени, за который произошли изменения в сети.
\-- OSPF конвергирует быстрее любой версии RIP.

Главный недостаток OSPF, особенно в сравнении с RIP, то что OSPF тратит намного больше ресурсов маршрутизатора (ЦПУ и память), чем RIP.

### Устранение неполадок соседних маршрутизаторов

Как вы знаете из курса CCNA, установление соседства в OSPF проходит через следущие этапы: _Down, Attempt, Init, 2-Way, Exstart, Exchange, Loading, Full_. Вот небольшой обзор того, что происходит на каждом этапе:

\-- _Down_ - от соседа не получено ни одного Hello-пакета.
\-- _Attempt_ - одноадресатный Hello-пакет отправлен соседу. Такое можно встретить только в сетях NBMA, так как там используется команда _neighbor_.
\-- _Init_ - первый Hello-пакет получен от соседа.
\-- _2-Way_ - каждый маршрутизатор получил Hello-пакет, содержащий его собственный RID, следовательно двусторонний обмен сообщениями имел место. Когда маршрутизатор получает Hello-пакет, содержащий его собственный RID, это такой способ для удаленного маршрутизатора сказать "Я получил Hello-пакет, отправленный вами ранее".
\-- _Exstart_ - происходит выбор DR/BDR, начинается обмен информацией из базы данных состояния канала. Маршрутизатор с большим значением OSPF RID начнет обмен и увеличит значение первоначального порядкового номера, заданного на данном этапе.
\-- _Exchange_ - произошел обмен пакетами дескриптора БД (DBD). Эти пакеты содержат описание базы данных состояния канала.
\-- _Loading_ - маршрутизаторы отправляют LSR своим потенциальным соседям.
\-- _Full_ - базы данных синхронизированы и соседство установлено.

Всегда пользуйтесь командами _show ip ospf neighbor_ и _show ip ospf interface_, чтобы убедиться, что соседство действительно установлено (этап Full). Соседство можно посмотреть с помощью любой из этих команд. _Show ip ospf neighbor_ дает вам основную информацию относительно соседства, тогда как команда _interface_ - более детальную.

<pre>
	R1#show ip ospf neighbor

	Neighbor ID    Pri     State       Dead Time   Address      Interface
	19.1.1.1        1   2WAY/DROTHER    00:00:38   100.1.1.5    Ethernet0
	172.12.123.3    1     FULL/-        00:00:35   13.13.13.3   Serial1

	R1#show ip ospf interface ethernet 0
	Ethernet0 is up, line protocol is up
		Internet Address 100.1.1.1/24, Area 0
		<b>Process ID 1, Router ID 10.1.1.1, Network Type BROADCAST, Cost: 10</b>
		Transmit Delay is 1 sec, <b>State BDR, Priority 1</b>
		Designater Router (ID) 19.1.1.1, Interface address 100.1.1.5
		Backup Designated router (ID) 10.1.1.1, Interface address 100.1.1.1
		Timer intervals configured, Hello 10, Dead 40, Wait 40, Retransmit 5
			Hello due in 00:00:06
		Index 2/2, flood queue length 0
		Next 0x0(0)/0x0(0)
		Last flood scan length is 1, maximum is 1
		Last flood scan time is 0 msec, maximum is 0 msec
		Neighbor Count is 1 , Adjacent neighbor count is 1
			<b>Adjacent with neighbor 19.1.1.1 (Designated Router)</b>
		Supress Hello for 0 neighbor(s)
</pre>

_Show ip ospf interface_ замечательная команда для просмотра деталей, связанных с Hello- и Dead-таймерами. Если вы не видите проблему с помощью команды _show_, можете запустить _debug ip ospf adj_, чтобы видеть как формируется (или нет) соседство. Вот часть вывода этой команды, можно видеть этапы процесса установления соседства в OSPF, вплоть до этапа Full:

<pre>
4d22h: OSPF: Rcv DBD from 10.1.1.1 on Serial1 seq 0x5DD opt 0x42 flag 0x7 len32 mtu 1500 state <b>INIT</b>
4d22h: OSPF: 2 Way Communication to 10.1.1.1 on Serial1, state <b>2WAY</b>
4d22h: OSPF: Send DBD to 10.1.1.1 on Serial1 seq 0x14EC opt 42 flag 0x7 len 32 
4d22h: OSPF: First DBD and we are not SLAVE
4d22h: OSFP: Rcv DBD from 10.1.1.1 on Serial1 seq 0x14EC opt 0x42 flag 0x2 len 92 mtu 1500 state <b>EXSTART</b>
4d22h: OSPF: NBR Negotiation Done. We are the <b>MASTER</b>
4d22h: OSPF: Send DBD to 10.1.1.1 on Serial1 seq 0x14ED opt 0x42 flag 0x3 len 92
4d22h: OSPF: Database request to 10.1.1.1
4d22h: OSPF: sent LS REQ packet to 13.13.13.1, length 12
4d22h: OSPF: Rcv DBD from 10.1.1.1 on Serial1 seq 0x14ED opt 0x42 flag 0x0 len 32 mtu 1500 state <b>EXCHANGE</b>
4d22h: OSPF: Send DBD to 10.1.1.1 on Serial1 seq 0x14EE opt 42 flag 0x1 len 32
4d22h: OSPF: Rcv DBD from 10.1.1.1 on Serial1 seq 0x14EЕ opt 0x42 flag 0x0 len 32 mtu 1500 state <b>EXCHANGE</b>
4d22h: OSPF: Exchange Done with 10.1.1.1 on Serial1
R22h: OSPF: Synchronized with 10.1.1.1 on Serail1, state FULL
4d22h: %OSPF-5-ADJCHG: Process 1, Nbr 10.1.1.1 on Serial1 from <b>LOADING</b> to <b>FULL</b>,
Loading Done

4d22h: OSPF: Build Router LSA for area 0, router ID 172.12.123.3, seq 0x80000005
</pre>

Кратко, для образования соседства должны быть согласованы следующие параметры:
\-- Hello- и Dead-таймеры.
\-- Area ID.
\-- флаг stub-зоны (on\off).
\-- пароль (если используется, то должен быть у обоих соседей).

Номер процесса совпадать не должен - это локальный параметр. (Да, знаю, я об этом уже говорил. И повторяю снова!:))

###Поведение соседей c несколькими маршрутизаторами OSPF в широковещательном сегменте

Когда у вас более 2 маршрутизаторов в широковещательном сегменте, результаты соседства могут быть интересными. Меня часто спрашивали об этом на Facebook и Twitter (@ccie12933, кстати), так что решил включить ответ сюда.

------вставить картинку--------

Выборы уже прошли, R1 - DR, R2 - BDR, R3, R4 - DROTHERS. Таблица соседей OSPF на маршрутизаторах R1 и 2 выглядит ожидаемо, но на R3 и 4 - несколько странно.

<pre>
	Router1#show ip ospf nei

	Neighbor ID    Pri     State              Dead Time   Address      Interface
	4.4.4.4        1   FULL/DROTHER           00:00:33   30.1.1.4    Ethernet0
	3.3.3.3        1   FULL/DROTHER           00:00:31   30.1.1.3    Ethernet0
	2.2.2.2        1     FULL/BDR             00:00:30   30.1.1.2    Ethernet0

	Router2#show ip ospf nei

	Neighbor ID    Pri     State              Dead Time   Address      Interface
	4.4.4.4        1   FULL/DROTHER           00:00:35   30.1.1.4    Ethernet0
	3.3.3.3        1   FULL/DROTHER           00:00:33   30.1.1.3    Ethernet0
	1.1.1.1        1     FULL/DR              00:00:39   30.1.1.1    Ethernet0

	Router3#show ip ospf nei

	Neighbor ID    Pri     State              Dead Time   Address      Interface
	4.4.4.4        1   <b>2WAY/DROTHER</b>    00:00:35   30.1.1.4    Ethernet0
	2.2.2.2        1   FULL/DROTHER           00:00:32   30.1.1.2    Ethernet0
	1.1.1.1        1     FULL/DR              00:00:39   30.1.1.1    Ethernet0

	Router4#show ip ospf nei

	Neighbor ID    Pri     State              Dead Time   Address      Interface
	2.2.2.2        1     FULL/BDR             00:00:29   30.1.1.2    Ethernet0
	1.1.1.1        1     FULL/DR              00:00:37   30.1.1.1    Ethernet0
	3.3.3.3        1   <b>2WAY/DROTHER</b>    00:00:30   30.1.1.3    Ethernet0
</pre>

Вы услышите выражение "stuck in 2-way", и многие считают, что так всегда происходит, но это не обязательно. DROTHER-ы никогда не закончат формировать соседство. Мы можем вернуться завтра и _снова_ увидеть "2-way".

Такое поведение по-умолчанию в OSPF ограничивает количество переданных пакетов LSA в широковещательном сегменте с числом маршрутизаторов больше 2.

Единственные маршрутизаторы, у которых есть соседство в сегменте со всеми остальными маршрутизаторами, это - DR и BDR. Каждый DRother будет формировать полное соседство с DR и BDR, но не с другим DRother-ом.

По этой причине любой маршрутизатор, заметивший изменения в сети, будет передавать информацию об этом только DR и BDR маршрутизаторам, оставшиеся DRother-ы узнают о них от DR.

_Теперь мы знаем основы OSPF идеально..._

_...давайте возьмемся за мультизоновый OSPF_

_Конец главы_

[1]: https://habrastorage.org/files/d79/ee0/8bc/d79ee08bc1da4f1dae09ce7bf4657fb5.png
[2]: https://habrastorage.org/files/6b8/59f/ff5/6b859fff55154b3a85f7088facc4f4a3.png
[3]: https://habrastorage.org/files/44a/d43/e64/44ad43e6471042bbadaae4d94fb57ccf.png
[4]: https://habrastorage.org/files/f7f/c55/19b/f7fc5519b43c4bb7b2fb533e862bd96f.png
[5]: https://habrastorage.org/files/aec/b02/09d/aecb0209df704189b967612bc496a0c9.png
[6]: https://habrastorage.org/files/461/391/9ed/4613919edfa54cb4926ae22d9fec5b09.png
[7]: https://habrastorage.org/files/5d0/7fc/599/5d07fc599d174a9598551ed4ba1b5e22.png
[8]: https://habrastorage.org/files/982/82b/c68/98282bc68ffd4b188c74ac0bc2b02363.png
[9]: https://habrastorage.org/files/6da/89e/ed1/6da89eed1dfb4598bdef0ea6e1182b2d.png
[10]: https://habrastorage.org/files/0bf/8e3/377/0bf8e33775d44ee785923a6777127a7d.png
[11]: https://habrastorage.org/files/5f5/f68/5b1/5f5f685b134f4bb2a7c0be6d8948c176.png
